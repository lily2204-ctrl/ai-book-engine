<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Create Your AI Book</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f9f9fb;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.container{
  width:900px;
  max-width:95vw;
  background:white;
  padding:40px;
  border-radius:20px;
  box-shadow:0 10px 40px rgba(0,0,0,0.05);
  text-align:center;
}

h1{
  margin-top:0;
  font-size:34px;
}

.row{
  display:flex;
  gap:14px;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:20px;
}

input,select{
  padding:12px 14px;
  border:1px solid #ddd;
  border-radius:12px;
  font-size:16px;
  min-width:160px;
}

.avatar{
  width:100px;
  height:100px;
  border-radius:50%;
  background:#f1f1f1;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  border:1px solid #eee;
}

.avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}

input[type="file"]{
  display:none;
}

.styleGrid{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:12px;
}

.styleCard{
  padding:14px 18px;
  border-radius:14px;
  border:2px solid #ddd;
  cursor:pointer;
  font-weight:600;
  transition:0.2s;
}

.styleCard:hover{
  border-color:#111;
}

.styleCard.active{
  border-color:#111;
  background:#111;
  color:white;
}

button{
  padding:14px 22px;
  border:none;
  border-radius:14px;
  background:#111;
  color:#fff;
  font-weight:700;
  cursor:pointer;
  min-width:180px;
  position:relative;
}

button:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

.spinner{
  width:16px;
  height:16px;
  border:3px solid #fff;
  border-top:3px solid transparent;
  border-radius:50%;
  display:inline-block;
  margin-left:8px;
  animation:spin 0.8s linear infinite;
}

@keyframes spin{
  to{ transform:rotate(360deg); }
}

.msg{
  margin-top:16px;
  font-weight:600;
}

.msg.err{
  color:#c40000;
}

.msg.ok{
  color:#0b8a00;
}
</style>
</head>

<body>
<div class="container">
  <h1>Create Your AI Book</h1>

  <div class="row">
    <label class="avatar">
      <input type="file" id="photoInput" accept="image/*" />
      <img id="avatarPreview" style="display:none;" />
      <span id="avatarIcon">+</span>
    </label>

    <input id="childName" placeholder="Child name" />

    <select id="age">
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5" selected>5</option>
      <option value="6">6</option>
      <option value="7">7</option>
    </select>

    <select id="theme">
      <option>Magical Forest</option>
      <option>Space Adventure</option>
      <option>Underwater Kingdom</option>
      <option>Superhero Day</option>
    </select>
  </div>

  <h3>Select Illustration Style</h3>

  <div class="styleGrid">
    <div class="styleCard active" data-style="Soft Storybook">Soft Storybook</div>
    <div class="styleCard" data-style="Pixar 3D">Pixar 3D</div>
    <div class="styleCard" data-style="Magical Fantasy">Magical Fantasy</div>
    <div class="styleCard" data-style="Minimal Scandinavian">Minimal Scandinavian</div>
  </div>

  <div style="margin-top:30px;">
    <button id="createBtn" onclick="createBook()">Create Book</button>
  </div>

  <div id="msg" class="msg"></div>
</div>

<script>
const API_BASE = "https://romantic-patience-production.up.railway.app";

let selectedStyle = "Soft Storybook";
let isLoading = false;

const msgEl = document.getElementById("msg");
const btn = document.getElementById("createBtn");

document.querySelectorAll(".styleCard").forEach(card=>{
  card.addEventListener("click", ()=>{
    document.querySelectorAll(".styleCard").forEach(c=>c.classList.remove("active"));
    card.classList.add("active");
    selectedStyle = card.dataset.style;
  });
});

document.getElementById("photoInput").addEventListener("change",(e)=>{
  const file = e.target.files?.[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    localStorage.setItem("childPhoto", reader.result);
    document.getElementById("avatarPreview").src = reader.result;
    document.getElementById("avatarPreview").style.display="block";
    document.getElementById("avatarIcon").style.display="none";
  };
  reader.readAsDataURL(file);
});

async function createBook(){
  if(isLoading) return;

  msgEl.textContent="";
  msgEl.className="msg";

  const name = document.getElementById("childName").value.trim();

  if(!name){
    msgEl.textContent="Please enter a child name.";
    msgEl.classList.add("err");
    return;
  }

  isLoading = true;
  btn.disabled = true;
  btn.innerHTML = "Creating<span class='spinner'></span>";

  try{
    const res = await fetch(`${API_BASE}/create-book`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        child_name: name,
        age: document.getElementById("age").value,
        story_type: document.getElementById("theme").value,
        illustration_style: selectedStyle,
        child_photo: localStorage.getItem("childPhoto")
      })
    });

    const data = await res.json();

    if(!res.ok){
      throw new Error(data?.message || "Failed to create book");
    }

    data.illustration_style = selectedStyle;

    localStorage.setItem("bookData", JSON.stringify(data));

    msgEl.textContent="Success! Opening preview...";
    msgEl.classList.add("ok");

    setTimeout(()=>{
      window.location.href="preview.html";
    },800);

  }catch(err){
    msgEl.textContent = err.message;
    msgEl.classList.add("err");
  }finally{
    isLoading=false;
    btn.disabled=false;
    btn.innerHTML="Create Book";
  }
}
</script>
</body>
</html>
