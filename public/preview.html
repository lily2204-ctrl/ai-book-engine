<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Book Preview</title>
<style>
  body{margin:0;background:#eef1ff;font-family:Arial;text-align:center;}
  header{padding:18px 12px;}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:14px;padding-bottom:40px;}
  .bookStage{perspective:2200px;margin-top:10px;}
  .book{width:900px;max-width:95vw;height:560px;position:relative;}
  .page{position:absolute;inset:0;transform-origin:left center;transition:transform .75s ease;transform-style:preserve-3d;}
  .page.flipped{transform:rotateY(-180deg);}
  .side{position:absolute;inset:0;border-radius:18px;backface-visibility:hidden;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.12);}
  .front{background:white;}
  .back{background:white;transform:rotateY(180deg);}
  .coverFront{
    background:linear-gradient(135deg,#ff7eb3,#6a5cff);
    color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:14px;
    padding:40px;
  }
  .coverFront h1{margin:0;font-size:44px;}
  .coverFront p{margin:0;font-size:18px;opacity:.95;}
  .coverPhoto{width:220px;height:220px;border-radius:18px;background:rgba(255,255,255,.18);overflow:hidden;border:2px solid rgba(255,255,255,.25);}
  .coverPhoto img{width:100%;height:100%;object-fit:cover;}
  .spineBack{
    background:linear-gradient(135deg,#6a5cff,#ff7eb3);
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;
    letter-spacing:.6px;font-size:22px;
  }
  .paper{padding:34px 34px 54px 34px;text-align:left;line-height:1.6;font-family:Georgia;}
  .pageNum{position:absolute;bottom:16px;right:22px;font-size:12px;color:#999;}
  .aiBox{margin-top:14px;border:1px dashed #cfcfff;border-radius:14px;padding:10px 12px;background:#fafbff;color:#333;font-size:12px;}
  .illus{
    margin-top:16px;width:100%;height:210px;border-radius:14px;background:#f2f3ff;
    display:flex;align-items:center;justify-content:center;color:#777;font-size:13px;
  }
  .illus img{width:100%;height:100%;object-fit:cover;}
  .shadow{
    width:65%;max-width:600px;height:28px;margin:18px auto 0 auto;
    background:rgba(0,0,0,.25);filter:blur(16px);border-radius:50%;
  }
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  button{padding:10px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:800;}
  .primary{background:#111;color:#fff;}
  .secondary{background:#fff;}
  .ghost{background:#eef0ff;}
  .bar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:6px;}
  .note{color:#666;font-size:13px;}
</style>
</head>

<body>
<header>
  <h2 style="margin:0;">Book Preview</h2>
  <div class="note">Flip pages like a real book. (Images will be enabled next.)</div>
</header>

<div class="wrap">
  <div class="bookStage">
    <div id="book" class="book"></div>
    <div class="shadow"></div>
  </div>

  <div class="controls">
    <button class="secondary" onclick="prevPage()">Previous</button>
    <button class="primary" onclick="nextPage()">Next</button>
  </div>

  <div class="bar">
    <button class="ghost" onclick="downloadPDF()">Download PDF</button>
    <button class="primary" onclick="orderPrinted()">Order Printed Version</button>
  </div>
</div>

<script>
  let pages = [];
  let flipIndex = 0;

  function getBookData(){
    const raw = localStorage.getItem("bookData");
    if(!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function buildFlipbook(){
    const data = getBookData();
    if(!data || !data.pages) {
      document.body.innerHTML = "<h3>Missing book data. Go back and create a book first.</h3>";
      return;
    }

    const childPhoto = localStorage.getItem("childPhoto");
    const bookEl = document.getElementById("book");
    bookEl.innerHTML = "";
    pages = [];
    flipIndex = 0;

    // 1) Cover (counts as a flip page)
    const cover = document.createElement("div");
    cover.className = "page";
    cover.style.zIndex = 9999;

    cover.innerHTML = `
      <div class="side coverFront front">
        <h1>${escapeHtml(data.title || "My Magical Story")}</h1>
        <p>${escapeHtml(data.subtitle || "A personalized adventure")}</p>
        <div class="coverPhoto">
          ${childPhoto ? `<img src="${childPhoto}" />` : `<div style="padding:18px;">Upload photo in the wizard</div>`}
        </div>
      </div>
      <div class="side spineBack back">
        ${escapeHtml(data.title || "My Magical Story")}
      </div>
    `;
    bookEl.appendChild(cover);
    pages.push(cover);

    // 2) Content pages: each flip page contains 2 book pages (front/back)
    // So we create 5 flip-pages for 10 pages
    for(let i=0; i<data.pages.length; i+=2){
      const left = data.pages[i];
      const right = data.pages[i+1];

      const page = document.createElement("div");
      page.className = "page";
      page.style.zIndex = 9998 - (i/2);

      page.innerHTML = `
        <div class="side front paper">
          <div class="illus">AI Illustration (next step)</div>
          <div>${escapeHtml(left.text)}</div>
          <div class="aiBox"><b>Illustration prompt:</b> ${escapeHtml(left.imagePrompt)}</div>
          <div class="pageNum">Page ${left.pageNumber}</div>
        </div>

        <div class="side back paper">
          <div class="illus">AI Illustration (next step)</div>
          <div>${escapeHtml(right.text)}</div>
          <div class="aiBox"><b>Illustration prompt:</b> ${escapeHtml(right.imagePrompt)}</div>
          <div class="pageNum">Page ${right.pageNumber}</div>
        </div>
      `;

      bookEl.appendChild(page);
      pages.push(page);
    }
  }

  function nextPage(){
    if(flipIndex < pages.length){
      pages[flipIndex].classList.add("flipped");
      flipIndex++;
    }
  }

  function prevPage(){
    if(flipIndex > 0){
      flipIndex--;
      pages[flipIndex].classList.remove("flipped");
    }
  }

  // Placeholder: PDF + Shopify (weâ€™ll implement properly in the next step)
  function downloadPDF(){
    alert("Next step: we'll generate a real designed PDF from the same pages (server-side).");
  }

  function orderPrinted(){
    alert("Next step: connect to Shopify checkout (Order Printed Version).");
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  buildFlipbook();
</script>

</body>
</html>
