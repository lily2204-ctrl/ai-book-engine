<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Book Preview</title>
<style>
  body{font-family:Arial;background:#f6f7fb;margin:0;padding:24px;}
  .wrap{max-width:920px;margin:0 auto;}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
  h1{margin:0;font-size:26px;}
  .page{background:#fff;border-radius:18px;padding:18px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,0.06);}
  .imgBox{height:320px;border-radius:14px;background:#eef1ff;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;}
  .imgBox img{width:100%;height:100%;object-fit:cover;}
  .loader{font-weight:700;color:#555;}
  .text{margin-top:14px;font-size:18px;line-height:1.6;}
  .prompt{margin-top:10px;padding:12px;border:1px dashed #cfd6ff;border-radius:12px;color:#444;background:#fbfcff;}
  .prompt b{color:#111;}
  .btn{padding:10px 14px;border:none;border-radius:12px;background:#111;color:#fff;font-weight:700;cursor:pointer;}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <h1 id="title">Book Preview</h1>
    <button class="btn" onclick="window.location.href='wizard.html'">Back</button>
  </div>
  <div id="pages"></div>
</div>

<script>
  const API_BASE = "https://romantic-patience-production.up.railway.app";

  const bookRaw = localStorage.getItem("bookData");
  if (!bookRaw) {
    document.getElementById("pages").innerHTML = "<p>No book data found. Go back and create a book.</p>";
    throw new Error("No bookData in localStorage");
  }

  const book = JSON.parse(bookRaw);
  document.getElementById("title").textContent = book?.title ? `Book Preview - ${book.title}` : "Book Preview";

  const pagesEl = document.getElementById("pages");
  const pages = Array.isArray(book.pages) ? book.pages : [];
  const style = book.illustration_style || "Soft Storybook";

  // simple concurrency limiter
  let active = 0;
  const queue = [];
  const MAX_CONCURRENT = 2;

  function runNext() {
    if (active >= MAX_CONCURRENT) return;
    const job = queue.shift();
    if (!job) return;
    active++;
    job().finally(() => {
      active--;
      runNext();
    });
  }

  function enqueue(job) {
    queue.push(job);
    runNext();
  }

  async function generateImage(prompt, imgEl, loaderEl) {
    const res = await fetch(`${API_BASE}/generate-image`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt,
        illustration_style: style
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data?.message || "Image generation failed");

    imgEl.src = data.imageBase64;
    imgEl.style.display = "block";
    loaderEl.style.display = "none";
  }

  function createPageCard(p) {
    const card = document.createElement("div");
    card.className = "page";

    const imgBox = document.createElement("div");
    imgBox.className = "imgBox";

    const loader = document.createElement("div");
    loader.className = "loader";
    loader.textContent = "Generating illustration...";

    const img = document.createElement("img");
    img.style.display = "none";

    imgBox.appendChild(loader);
    imgBox.appendChild(img);

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = p.text || "";

    const prompt = document.createElement("div");
    prompt.className = "prompt";
    prompt.innerHTML = `<b>Illustration prompt:</b> ${p.imagePrompt || ""}`;

    card.appendChild(imgBox);
    card.appendChild(text);
    card.appendChild(prompt);

    // Lazy-load when visible
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
          observer.disconnect();
          enqueue(() => generateImage(p.imagePrompt || "", img, loader));
        }
      });
    }, { threshold: 0.3 });

    observer.observe(card);

    return card;
  }

  pages.forEach((p) => pagesEl.appendChild(createPageCard(p)));
</script>
</body>
</html>
