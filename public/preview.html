<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Preview</title>
  <style>
    body { font-family: Arial; background: #f5f6fa; margin: 0; padding: 30px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    h1 { margin: 0 0 18px 0; font-size: 28px; }
    .btn { padding:10px 14px; border:none; border-radius:12px; background:#111; color:#fff; font-weight:700; cursor:pointer; }
    .wrap { max-width: 1000px; margin: 0 auto; }
    .page {
      background:#fff;
      border-radius:18px;
      padding:18px;
      margin:18px 0;
      box-shadow:0 8px 22px rgba(0,0,0,0.06);
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    .imgBox {
      width: 280px;
      height: 280px;
      border-radius:16px;
      background:#eef0ff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .imgBox img {
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .loader { color:#666; font-weight:700; }
    .text { font-size: 18px; line-height: 1.6; margin-top: 4px; }
    .prompt {
      margin-top: 14px;
      padding: 12px 14px;
      border: 1px dashed #cdd2ff;
      border-radius: 14px;
      color: #444;
      background:#fafbff;
      font-size: 14px;
    }
    .errline {
      margin-top: 10px;
      color:#c40000;
      font-weight:700;
    }
    @media (max-width: 820px) {
      .page { grid-template-columns: 1fr; }
      .imgBox { width:100%; height:240px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 id="title">Book Preview</h1>
      <button class="btn" onclick="goBack()">Back</button>
    </div>

    <div id="pages"></div>
  </div>

<script>
  const API_BASE = "https://romantic-patience-production.up.railway.app";

  function goBack(){
    window.location.href = "wizard.html";
  }

  const bookRaw = localStorage.getItem("bookData");
  if (!bookRaw) {
    document.getElementById("pages").innerHTML = "<p>No book data found. Go back and create a book.</p>";
    throw new Error("No bookData in localStorage");
  }

  const book = JSON.parse(bookRaw);
  document.getElementById("title").textContent = book?.title ? `Book Preview - ${book.title}` : "Book Preview";

  const pagesEl = document.getElementById("pages");
  const pages = Array.isArray(book.pages) ? book.pages : [];
  const style = book.illustration_style || "Soft Storybook";

  // simple concurrency limiter (keeps UI responsive + avoids hammering API)
  let active = 0;
  const queue = [];
  const MAX_CONCURRENT = 2;

  function runNext() {
    if (active >= MAX_CONCURRENT) return;
    const job = queue.shift();
    if (!job) return;
    active++;
    job().finally(() => {
      active--;
      runNext();
    });
  }

  function enqueue(job) {
    queue.push(job);
    runNext();
  }

  function saveBookDataSafely() {
    // bookData stays small because we store only URLs, not base64
    localStorage.setItem("bookData", JSON.stringify(book));
  }

  async function generateImageAndPersist(pageIndex, prompt, imgEl, loaderEl, errEl) {
    try {
      errEl.textContent = "";

      const res = await fetch(`${API_BASE}/generate-image`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          prompt,
          illustration_style: style
        })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data?.details || data?.message || "Image generation failed");

      const urlPath = data.imageUrl; // like "/generated/xxx.png"
      const fullUrl = urlPath.startsWith("http") ? urlPath : `${API_BASE}${urlPath}`;

      // Persist URL inside bookData so it won't regenerate on next load
      book.pages[pageIndex].imageUrl = fullUrl;
      saveBookDataSafely();

      imgEl.src = fullUrl;
      imgEl.style.display = "block";
      loaderEl.style.display = "none";
    } catch (e) {
      loaderEl.style.display = "none";
      errEl.textContent = `Image failed: ${e.message}`;
    }
  }

  function createPageCard(p, pageIndex) {
    const card = document.createElement("div");
    card.className = "page";

    const imgBox = document.createElement("div");
    imgBox.className = "imgBox";

    const loader = document.createElement("div");
    loader.className = "loader";
    loader.textContent = "Generating illustration...";

    const img = document.createElement("img");

    const errLine = document.createElement("div");
    errLine.className = "errline";

    imgBox.appendChild(loader);
    imgBox.appendChild(img);

    const right = document.createElement("div");

    const text = document.createElement("div");
    text.className = "text";
    text.textContent = p.text || "";

    const prompt = document.createElement("div");
    prompt.className = "prompt";
    prompt.innerHTML = `<b>Illustration prompt:</b> ${p.imagePrompt || ""}`;

    right.appendChild(text);
    right.appendChild(prompt);
    right.appendChild(errLine);

    card.appendChild(imgBox);
    card.appendChild(right);

    // If already generated before, show it immediately (NO re-generate)
    if (p.imageUrl) {
      img.src = p.imageUrl;
      img.style.display = "block";
      loader.style.display = "none";
      return card;
    }

    // Lazy-load when visible
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (e.isIntersecting) {
          observer.disconnect();
          enqueue(() => generateImageAndPersist(pageIndex, p.imagePrompt || "", img, loader, errLine));
        }
      });
    }, { threshold: 0.3 });

    observer.observe(card);

    return card;
  }

  pages.forEach((p, i) => pagesEl.appendChild(createPageCard(p, i)));
</script>
</body>
</html>
